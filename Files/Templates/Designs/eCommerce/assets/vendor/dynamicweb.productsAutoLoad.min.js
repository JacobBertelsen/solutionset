/*
* dynamicweb.productsAutoLoad.js
* Copyright (c) 2013 Dynamicweb
* http://www.opensource.org/licenses/mit-license.php
*/
(function(e){function t(t){var r=e(document).height()-e(window).height()-e(window).scrollTop();if(r<t.options.bottomDistance&&!t.options.isActive){n(t)}}function n(t){var n,r=t.options.requestPath,i=window.location.search.substring(1),s=e(t.options.productsContainer);if(t.options.currentPage>=t.options.pageCount)return;t.options.currentPage++;r+=(t.options.requestPath.indexOf("?")===-1?"?":"&")+(i.length?i+"&":"")+"PageNum="+t.options.currentPage;n=e.ajax({url:r,dataType:"html",beforeSend:function(){t.options.isActive=true;eCommerce.Overlay.show(document.body)},success:function(n){eCommerce.Overlay.hide();var r=e(n).filter("div#content-main");s.append(r.html());t.options.onProductsLoaded()},complete:function(){eCommerce.Overlay.hide();t.options.isActive=false}});return}function r(t){try{var n=t.options;if(n.requestPath===null){throw"productsAutoLoad ==> Plugin option 'requestPath' must be specified"}if(n.productsContainer===null){throw"productsAutoLoad ==> Plugin option 'productsContainer' must be specified"}var r=parseInt(e(n.amountSelector).html());var i=parseInt(e(n.pageSizeSelector).html());var s=Math.ceil(r/i);if(r<=i){throw"productsAutoLoad ==> Not enough products in the list"}e.extend(t.options,{amount:r,pageSize:i,pageCount:s,currentPage:1});if(t.options.pagingSelector!==null){e(t.options.pagingSelector).hide()}return true}catch(o){if(t.options.debug)console.log(o);return false}}e.fn.productsAutoLoad=function(n){if(n){n=e.extend({},e.fn.productsAutoLoad.defaultOptions,n)}else{n=e.fn.productsAutoLoad.defaultOptions}return this.each(function(){var i={options:n,target:e(this)};if(r(i)){e(window).scroll(function(){t(i)})}else{}})};e.fn.productsAutoLoad.defaultOptions={debug:false,requestPath:null,amountSelector:"#allProductCount",pageSizeSelector:"#productsPageSize",pagingSelector:null,productsContainer:null,bottomDistance:100,isActive:false,onProductsLoaded:function(){}};})(jQuery)